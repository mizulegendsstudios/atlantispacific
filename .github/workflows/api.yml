name: API Server

on:
  workflow_dispatch:
  repository_dispatch:
    types: [db-update]

jobs:
  process:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Run API Server
        run: |
          cat > server.js << 'EOF'
          const fs = require('fs');
          const http = require('http');
          const url = require('url');
          
          const DB_FILE = 'db.json';
          
          const server = http.createServer((req, res) => {
            res.setHeader('Access-Control-Allow-Origin', '*');
            res.setHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE');
            res.setHeader('Content-Control-Allow-Headers', 'Content-Type');
            
            if (req.method === 'OPTIONS') {
              res.writeHead(200);
              res.end();
              return;
            }
            
            const parsedUrl = url.parse(req.url, true);
            const path = parsedUrl.pathname.split('/').filter(Boolean);
            
            // GET /tabla - Leer todos
            if (req.method === 'GET' && path.length === 1) {
              const db = JSON.parse(fs.readFileSync(DB_FILE));
              const tabla = path[0];
              res.writeHead(200, {'Content-Type': 'application/json'});
              res.end(JSON.stringify(db[tabla] || []));
              return;
            }
            
            // GET /tabla/id - Leer uno
            if (req.method === 'GET' && path.length === 2) {
              const db = JSON.parse(fs.readFileSync(DB_FILE));
              const tabla = path[0];
              const id = parseInt(path[1]);
              const item = (db[tabla] || []).find(i => i.id === id);
              res.writeHead(200, {'Content-Type': 'application/json'});
              res.end(JSON.stringify(item || null));
              return;
            }
            
            // POST /tabla - Crear
            if (req.method === 'POST' && path.length === 1) {
              let body = '';
              req.on('data', chunk => body += chunk);
              req.on('end', () => {
                const db = JSON.parse(fs.readFileSync(DB_FILE));
                const tabla = path[0];
                if (!db[tabla]) db[tabla] = [];
                
                const nuevo = JSON.parse(body);
                nuevo.id = Date.now();
                db[tabla].push(nuevo);
                
                fs.writeFileSync(DB_FILE, JSON.stringify(db, null, 2));
                res.writeHead(201, {'Content-Type': 'application/json'});
                res.end(JSON.stringify(nuevo));
              });
              return;
            }
            
            res.writeHead(404);
            res.end('Not found');
          });
          
          server.listen(3000, () => console.log('API en puerto 3000'));
          EOF
          node server.js &
          sleep 5
          curl http://localhost:3000/productos
